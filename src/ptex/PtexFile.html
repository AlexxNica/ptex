<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="content-type">
  <title>Ptex File Format Specification</title>
</head>
<body>
<h1>Ptex File Format Specification Version 1 (prelim-16)<br>
</h1>
<br>
<h3>General Notes:</h3>
<ul>
  <li>A "face" is one face of a polymesh.&nbsp; Only triangle and quad
meshes are supported (but not mixed).&nbsp; Extension to non-quads
embedded in a quad mesh (or non-tris in a tri-mesh) may also be
possible but the task is significantly more difficult due to the
lack of a simple 0-1 parameterization per face.</li>
  <li>Every face has a unique index, or "faceid", which is implied by
the ordering in the "Face Info" block.&nbsp; The faceids are numbered
starting from zero.<br>
  </li>
  <li>A "channel" is a scalar data value stored in the file (e.g. one
component of a color).&nbsp; There can
be any number of channels in the file, but all channels must have the
same data type.&nbsp;
Channels are stored separately for better compression.</li>
  <li>A "level" is a set of data across all the faces at a particular
resolution.&nbsp; The first level is the full-res set of data where the
resolution of each face is specified in the "Face Info"
block.&nbsp; Subsequent levels are power-of-two reductions (i.e. "mip
maps").<br>
  </li>
  <li>One channel may be indicated as the alpha channel.&nbsp; When an
alpha
channel is present, the data values in the first level are stored
"unmultiplied" (as opposed to being premultiplied with the
alpha).&nbsp; This choice was made to preserve the original data
in the file as premultiplying can result in data loss.&nbsp; The
tradeoff is that the multiplication must now be handled during
filtering.&nbsp;&nbsp; Reduction levels are stored premultiplied.</li>
  <li>Compression, where indicated, uses the "deflate" algorithm as
implemented in
zlib's compress and uncompress functions.&nbsp; Differencing (where
each value is replaced by the difference between the value and the
preceeding value) may be used where indicated to achieve
better compression.<br>
  </li>
  <li>All data is stored in "little endian" format.</li>
  <li>Face data is stored in v-major order with the first sample being
u=v=0.&nbsp; Note: there is no notion of top, bottom, left, or right as
in typical image formats.</li>
  <li>Triangle mesh data is stored in a packed triangle form (still in
v-major order, but rows become progressively shorter).<br>
  </li>
  <li>No padding or data alignment within the file is assumed beyond
what is explicitly specified, though an attempt is made to keep data
aligned within structures.&nbsp; However, data blocks are not generally
aligned on file offsets due to the variable length nature of the zip
compression.<br>
  </li>
</ul>
<h3><br>
</h3>
<h3>File Structure</h3>
<table style="text-align: left;" border="1" cellpadding="2"
 cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;">Header<br>
      </td>
      <td style="vertical-align: top;">description of file contents<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Extended Header<br>
      </td>
      <td style="vertical-align: top;">(reserved for future use)<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Face Info<br>
      </td>
      <td style="vertical-align: top;">information about each face<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Constant Data</td>
      <td style="vertical-align: top;">pre-filtered, constant valued
data for each face</td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Level Info<br>
      </td>
      <td style="vertical-align: top;">information about each level<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Level Data<br>
      </td>
      <td style="vertical-align: top;">data for each level<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Meta Data</td>
      <td style="vertical-align: top;">miscellaneous data</td>
    </tr>
    <tr>
      <td style="vertical-align: top;">Edit Data<br>
      </td>
      <td style="vertical-align: top;">incremental edits posted to the
file<br>
      </td>
    </tr>
  </tbody>
</table>
<br>
<h3>Header</h3>
<table style="text-align: left;" border="1" cellpadding="2"
 cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;">magic<br>
      </td>
      <td style="vertical-align: top;">char[4]<br>
      </td>
      <td style="vertical-align: top;">magic identifier = string "Ptex"<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">version<br>
      </td>
      <td style="vertical-align: top;">uint32<br>
      </td>
      <td style="vertical-align: top;">version number (=1)<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">meshtype<br>
      </td>
      <td style="vertical-align: top;">uint32<br>
      </td>
      <td style="vertical-align: top;">0=triangle, 1=quad<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">datatype<br>
      </td>
      <td style="vertical-align: top;">uint32<br>
      </td>
      <td style="vertical-align: top;">0=uint8, 1=uint16, 2=float16,
3=float32<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">alphachan<br>
      </td>
      <td style="vertical-align: top;">uint32<br>
      </td>
      <td style="vertical-align: top;">index of alpha channel<br>
&nbsp;-1 (0xffffffff) indicates no
alpha channel<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">nchannels</td>
      <td style="vertical-align: top;">uint32</td>
      <td style="vertical-align: top;">number of data channels</td>
    </tr>
    <tr>
      <td style="vertical-align: top;">nlevels</td>
      <td style="vertical-align: top;">uint32</td>
      <td style="vertical-align: top;">number of levels</td>
    </tr>
    <tr>
      <td style="vertical-align: top;">nfaces<br>
      </td>
      <td style="vertical-align: top;">uint32<br>
      </td>
      <td style="vertical-align: top;">number of faces<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">extheadersize<br>
      </td>
      <td style="vertical-align: top;">uint32<br>
      </td>
      <td style="vertical-align: top;">size of Extended Header block<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">faceinfosize<br>
      </td>
      <td style="vertical-align: top;">uint32<br>
      </td>
      <td style="vertical-align: top;">size of Face Info block </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">constdatasize</td>
      <td style="vertical-align: top;">uint32</td>
      <td style="vertical-align: top;">size of Constant Data block</td>
    </tr>
    <tr>
      <td style="vertical-align: top;">levelinfosize<br>
      </td>
      <td style="vertical-align: top;">uint32<br>
      </td>
      <td style="vertical-align: top;">size of Level Info block </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">leveldatasize</td>
      <td style="vertical-align: top;">uint64</td>
      <td style="vertical-align: top;">total size of all Level Data
blocks<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">metadatazipsize<br>
      </td>
      <td style="vertical-align: top;">uint32<br>
      </td>
      <td style="vertical-align: top;">on-disk size of Meta Data block
(zipped)<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">metadatamemsize<br>
      </td>
      <td style="vertical-align: top;">uint32<br>
      </td>
      <td style="vertical-align: top;">in-memory size of Meta Data
block (unzipped)<br>
      </td>
    </tr>
  </tbody>
</table>
<br>
<h3>Extended Header</h3>
This block is reserved for future use.<br>
<br>
<h3>Face Info</h3>
Information about the resolution and topological adjacency of each face.<br>
<br>
<table style="text-align: left;" border="1" cellpadding="2"
 cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;">ures<br>
      </td>
      <td style="vertical-align: top;">uint8<br>
      </td>
      <td style="vertical-align: top;">log2(number of samples in u
direction)<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">vres<br>
      </td>
      <td style="vertical-align: top;">uint8<br>
      </td>
      <td style="vertical-align: top;">log2(number of samples in v
direction)<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">adjedges</td>
      <td style="vertical-align: top;">uint8</td>
      <td style="vertical-align: top;">ids of edges on adjacent faces
(0 .. 3) x 4 faces (see notes)<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">flags<br>
      </td>
      <td style="vertical-align: top;">uint8<br>
      </td>
      <td style="vertical-align: top;">bit0=constant - all pixels in
face have same value<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">adjfaces<br>
      </td>
      <td style="vertical-align: top;">uint32[4]<br>
      </td>
      <td style="vertical-align: top;">faceids of adjacent faces (0 ..
nfaces)<br>
-1 (0xffffffff) indicates a border (no adjacent face)<br>
      </td>
    </tr>
  </tbody>
</table>
(times number of faces)<br>
<br>
Notes:<br>
<ul>
  <li>The entire block is zip compressed and the
size is indicated in the header.</li>
  <li>Constant faces (indicated by flag bit0) are only stored in the
Constant Data section and not in the Level Data section.<br>
  </li>
  <li>The "adjedge" values are stored as 2-bit values in
little-endian order (i.e the first entry is stored in the lowest 2
bits, etc.). <br>
  </li>
  <li>For triangle meshes, the adjface array has only 3
entries but 4 entries are still
allocated to simplify the implementation (the 4th entry in each case is
0).</li>
</ul>
<br>
<h3>Constant Data</h3>
The constant data block contains a single value per channel for
each
face.&nbsp; These values represent the average of the values for the
face.<br>
<ul>
  <li>The data block contains the first channel for all the faces (in
faceid
order), then the second channel, etc.</li>
  <li>The entire block is zip
compressed
as a single unit (with no differencing).</li>
  <li>For textures with alpha, the values are stored
un-multiplied.&nbsp; This is done to exactly preserve the original data
values for constant-valued faces.&nbsp; Faces that are not constant are
pre-multiplied with alpha, averaged, and then divided by alpha.<br>
  </li>
</ul>
<br>
<h3>Level Info</h3>
The data are grouped into levels with the first level representing the
full-res data for all of the faces, the next level representing a
power-of-two reduction of the first (half the res in both u and v), and
subsequent levels representing half the previous level.&nbsp; The Level
Info
block lists the number of
faces in the level and size of each level's data.&nbsp; <br>
<br>
<table style="text-align: left;" border="1" cellpadding="2"
 cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;">leveldatasize<br>
      </td>
      <td style="vertical-align: top;">uint64<br>
      </td>
      <td style="vertical-align: top;">size of level's data block
(including level data header)<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">levelheadersize<br>
      </td>
      <td style="vertical-align: top;">uint32<br>
      </td>
      <td style="vertical-align: top;">compressed size of level data
header<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">nfaces<br>
      </td>
      <td style="vertical-align: top;">uint32<br>
      </td>
      <td style="vertical-align: top;">number of faces in level<br>
      </td>
    </tr>
  </tbody>
</table>
(times number of levels)<br>
<br>
Notes:<br>
<ul>
  <li>The first level stores faces in faceid order.&nbsp; All faces in
the file are included.<br>
  </li>
  <li>Reduction levels exclude constant faces and store non-constant
faces in largest-to-smallest order
(according to the smaller dimension of each face).&nbsp; Ordering among
faces with the same smaller-dimension size follows the
original face id
order.&nbsp; The purpose of this ordering is to allow each level to
remain fully populated as the smallest faces may be omitted from the
level.</li>
  <li>The number of faces in reduction levels may be less than the
total number of faces in the file:</li>
  <ul>
    <li>The level data only includes non-constant faces (as indicated
by the
"constant" flag in the face data header).</li>
  </ul>
  <ul>
    <li>As face resolutions are reduced, small faces may be omitted
from further reduction levels.<br>
    </li>
  </ul>
</ul>
<br>
<h3>Level Data</h3>
Each Level Data block (one per chunk) consists of a header containing a
list of face sizes
followed by a
number of face data blocks of the given sizes.&nbsp; Non-constant
face data is packed (with channels separated)
and then optionally differenced and compressed.<br>
<br>
Level data header (compressed):<br>
<table style="text-align: left;" border="1" cellpadding="2"
 cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;">facesize<br>
      </td>
      <td style="vertical-align: top;">uint32 (bits 0..29)<br>
      </td>
      <td style="vertical-align: top;">sizes of data block for each face<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">encoding<br>
      </td>
      <td style="vertical-align: top;">bits 30..31 of facesize<br>
      </td>
      <td style="vertical-align: top;">0 = constant valued (1 sample
per channel)<br>
1 = zip compressed<br>
2 = zip compressed w/ differencing<br>
3 = tiled<br>
      </td>
    </tr>
  </tbody>
</table>
(times number of faces in level)<br>
<br>
For tiled faces, the face data begins with the following pre-header:<br>
<table style="text-align: left;" border="1" cellpadding="2"
 cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;">tileures<br>
      </td>
      <td style="vertical-align: top;">uint8<br>
      </td>
      <td style="vertical-align: top;">log2(number of samples per tile
in u
direction) <br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">tilevres<br>
      </td>
      <td style="vertical-align: top;">uint8<br>
      </td>
      <td style="vertical-align: top;">log2(number of samples per tile
in v
direction)<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">tileheadersize<br>
      </td>
      <td style="vertical-align: top;">uint32<br>
      </td>
      <td style="vertical-align: top;">compressed size of tile header<br>
      </td>
    </tr>
  </tbody>
</table>
<br>
and is followed by a compressed header listing the tile sizes and
encodings:<br>
<table style="text-align: left;" border="1" cellpadding="2"
 cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;">tilesizes<br>
      </td>
      <td style="vertical-align: top;">uint32 (bits 0..29)<br>
      </td>
      <td style="vertical-align: top;">sizes of data block for each tile<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">encoding<br>
      </td>
      <td style="vertical-align: top;">bits 30..31 of tilesize<br>
      </td>
      <td style="vertical-align: top;">0 = constant valued (1 sample
per channel)<br>
1 = zip compressed<br>
2 = zip compressed w/ differencing</td>
    </tr>
  </tbody>
</table>
(times number of tiles in face)<br>
<br>
Each tile is then stored separately (with tiles in v-major order) in
the same manner as the untiled face data.&nbsp; Note: the number of
tiles for a face is determined by comparing the tile_ures and tile_vres
with the ures and vres of the face.&nbsp;
For triangle meshes, some of the tiles may be rectangular.&nbsp; (A
diagram is probably needed here.)<br>
<br>
<br>
<h3>Meta Data<br>
</h3>
Miscellaneous application defined data.&nbsp; Possibilities include
channel names, timestamp, software settings, 3d vertex data, etc.&nbsp;
The
meta data is a stream of individual data blocks.<br>
<br>
Meta data block<br>
<table style="text-align: left;" border="1" cellpadding="2"
 cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;">keysize<br>
      </td>
      <td style="vertical-align: top;">uint32<br>
      </td>
      <td style="vertical-align: top;">length of key string (including
null)<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">key<br>
      </td>
      <td style="vertical-align: top;">uint8[keysize]<br>
      </td>
      <td style="vertical-align: top;">ascii character string
(null-terminated)<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">datatype<br>
      </td>
      <td style="vertical-align: top;">uint32<br>
      </td>
      <td style="vertical-align: top;">0=ascii, 1=int8, 2=int16,
3=int32, 4=float, 5=double<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">datasize<br>
      </td>
      <td style="vertical-align: top;">uint32<br>
      </td>
      <td style="vertical-align: top;">size of data block (in bytes)<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">data<br>
      </td>
      <td style="vertical-align: top;">uint8[datasize]<br>
      </td>
      <td style="vertical-align: top;">data block<br>
      </td>
    </tr>
  </tbody>
</table>
<ul>
  <li>The entire stream of data blocks is compressed as a whole.&nbsp;
The compressed and uncompressed sizes are both stored in the header.</li>
  <li>Ascii characters strings (both the key and "ascii" data values)
are stored null-terminated.&nbsp; The size includes the null character.<br>
  </li>
</ul>
<br>
<h3>Edit Data</h3>
The edit data block includes incremental data edits that are pending to
be applied to the file.&nbsp; The format is designed to allow appending
edit blocks to a file without otherwise affecting the file.<br>
<br>
Edit data block<br>
<table style="text-align: left;" border="1" cellpadding="2"
 cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;">edittype<br>
      </td>
      <td style="vertical-align: top;">uint8<br>
      </td>
      <td style="vertical-align: top;">1=edit face data, 2=edit meta
data<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">editsize<br>
      </td>
      <td style="vertical-align: top;">uint32<br>
      </td>
      <td style="vertical-align: top;">size of editdata block<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">editdata<br>
      </td>
      <td style="vertical-align: top;">(variable)<br>
      </td>
      <td style="vertical-align: top;">based on edit type<br>
      </td>
    </tr>
  </tbody>
</table>
<br>
Edit face data<br>
<table style="text-align: left;" border="1" cellpadding="2"
 cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;">faceid<br>
      </td>
      <td style="vertical-align: top;">uint32</td>
      <td style="vertical-align: top;">index of face<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">faceinfo<br>
      </td>
      <td style="vertical-align: top;">FaceInfo block<br>
      </td>
      <td style="vertical-align: top;">(as described in FaceInfo
section)<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">facesize &amp; encoding<br>
      </td>
      <td style="vertical-align: top;">uint32</td>
      <td style="vertical-align: top;">(as described in Level Data
section)<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">facedata<br>
      </td>
      <td style="vertical-align: top;">uint8[facesize]<br>
      </td>
      <td style="vertical-align: top;">encoded data block<br>
      </td>
    </tr>
  </tbody>
</table>
<br>
Edit meta data<br>
<table style="text-align: left;" border="1" cellpadding="2"
 cellspacing="2">
  <tbody>
    <tr>
      <td style="vertical-align: top;">metadatazipsize<br>
      </td>
      <td style="vertical-align: top;">uint32<br>
      </td>
      <td style="vertical-align: top;">compressed size of meta data<br>
      </td>
    </tr>
    <tr>
      <td style="vertical-align: top;">metadatamemsize</td>
      <td style="vertical-align: top;">uint32</td>
      <td style="vertical-align: top;">uncompressed size of meta data</td>
    </tr>
    <tr>
      <td style="vertical-align: top;">metadata<br>
      </td>
      <td style="vertical-align: top;">uint8[metazipsize]<br>
      </td>
      <td style="vertical-align: top;">one or more data blocks as
described in (Meta Data)<br>
      </td>
    </tr>
  </tbody>
</table>
<br>
<br>
</body>
</html>
